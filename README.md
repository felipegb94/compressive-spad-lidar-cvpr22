# compressive-spad-lidar-cvpr22

Code and Data for our CVPR 2022 paper *Compressive Single-Photon 3D Cameras*.

If you find the code and data in this repository useful please cite:

```
@InProceedings{Gutierrez-Barragan_2022_CVPR,
    author    = {Gutierrez-Barragan, Felipe and Ingle, Atul and Seets, Trevor and Gupta, Mohit and Velten, Andreas},
    title     = {Compressive Single-Photon 3D Cameras},
    booktitle = {Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR)},
    month     = {June},
    year      = {2022},
    pages     = {17854-17864}
}
```

- [compressive-spad-lidar-cvpr22](#compressive-spad-lidar-cvpr22)
  - [Getting Started](#getting-started)
    - [Step 1. Setup Python environment](#step-1-setup-python-environment)
    - [Step 2. Download the data](#step-2-download-the-data)
    - [Step 3. Setup data paths](#step-3-setup-data-paths)
  - [Reproducing Flash LiDAR Results](#reproducing-flash-lidar-results)
  - [Coding Schemes Evaluated In CVPR 2022 Paper](#coding-schemes-evaluated-in-cvpr-2022-paper)
  - [Visualization Scripts](#visualization-scripts)
  - [Notes on Naming Convention](#notes-on-naming-convention)
      - [Coding Schemes](#coding-schemes)
      - [Parameters](#parameters)

## Getting Started

Before running any of the scripts in this folder, please follow the following steps.

### Step 1. Setup Python environment

Create the conda envirionment (`csphenv`) from the `environment.yml`:

```
    conda env create -f environment.yml
```

### Step 2. Download the data

You should be able to run `scripts/download_data.py` from the top-level folder:

```
python scripts/download_data.py
```

The data will be download inside the `./data` folder. If you want to change the folder where the data is downloaded edit the parameter `data_base_dirpath` inside `io_dirpaths.json`.
### Step 3. Setup data paths

Open `io_dirpaths.json` and set the dirpaths where you want results to be stored, and also where you have stored the flash lidar data. Currently, these dirpaths are set to the local `./data` and `./results` folders.

The main dirpath that can be set (or left as default) is

* `data_base_dirpath`: This is the main dirpath where the data, results, and images will be saved. All the other dirpaths below will be specified with respect to this dirpath. 

Dirpaths to set:

* `results_base_dirpath`: Dirpath containing most data and figures generated by the scripts
* `results_data`: Dirpath where the data generated by scripts is stored
* `paper_results_dirpath`: Dirpath where plotting scripts will output plots to.
* `transient_images_dirpath`: Dirpath to transient rendered histogram images data. This data will be under the `data/rendered_images` folder that you downloaded in step 2.
* `rgb_images_dirpath`: Dirpath to rgb rendered images for the transient images. This data will be under the `data/rendered_images` folder that you downloaded in step 2.
* `depth_images_dirpath`: Dirpath to ground truth depth images for the transient images. This data will be under the `data/rendered_images` folder that you downloaded in step 2.
* `scan_data_base_dirpath`: Dirpath where the pre-processed scan histogram data is stored. This data will be under the `data/scan_data` folder that you downloaded in step 2.


## Reproducing Flash LiDAR Results

You can run the `eval_coding_flash_lidar_scene_batch.sh` script. In the script you can modify the desired `sbr`, `nphotons` (photon counts), `K`, to use in the simulation. You can also comment in and out the blocks of code that will simulate different coding schemes. The results will be saved under `results/results_data/eval_coding_flash_lidar`. Running the script for all coding schemes may take a few minutes.

To perform individual flash illumination simulations you can run the `eval_coding_flash_lidar_scene.py` script with the specified parameters. Some sample run commands are at the top of the scipt.

## Coding Schemes Evaluated In CVPR 2022 Paper

The implementation of the coding schemes used in the paper are implemented as individual classes and can be found under `tof-lib/toflib/coding.py`. 

The following classes have a one-to-one correspondence to the coding schemes described in the *main paper*:

1. `GatedCoding`: This class corresponds to **Coarse Histograms** coding scheme
2. `TruncatedFourierCoding`: This class corresponds to **Truncated Fourier** coding scheme.
3. `PSeriesFourierCoding`: This class corresponds to **Gray-based Fourier** coding scheme. This coding scheme samples frequencies from the Fourier matrix by doubling the frequency that is sampled. Once it cannot double the frequency anymore, it reverts back to `TruncatedFourierCoding` and samples the remaining frequencies from lowest to highest
4. `GrayCoding`: This class corresponds to **Continuous Gray** coding scheme. This coding scheme is exactly the same as Gray coding when `K == log2(N)`. For all other `K` values the Gray codes are linearly interpolated. Note that this scheme is only valid for `K <= log2(N)`. For a coding scheme that uses approximately binary codes and supports `K > log2(N)`, see `PSeriesGray` below. 
5. `IdentityCoding`: This class corresponds to **Full-resolution Histograms** where no compression is applied.

Furthermore, the following classes have a ont-to-one correspondence with the coding schemes described in the supplementary document:

1. `PSeriesGrayCoding`: This class corresponds to **Fourier-based Gray** coding scheme. This coding scheme is similar to `PSeriesFourierCoding` but uses binarized codes. When `K <= log2(N)`, this coding scheme is the same as `Gray`

## Visualization Scripts

The `plotting_scripts` folder has the different scripts used to generate most of the raw figures shown in the paper. For instance running: `python plotting_scripts/plot_example_irfs.py` will create the IRF plots in the paper.

These scripts will usually save the output images under `results/raw_figures`.

The scripts that plot the result figures require running the scan data script, flash illumination simulations, and MDE monte carlo simulations to create the results data used by the script.

## Notes on Naming Convention

#### Coding Schemes

1. PSeriesFourier == Gray-based Fourier 
2. PSeriesGray == Fourier-based Gray 
3. Gated == Coarse Histogram
4. GatedFourier-F-1 == Short-time Fourier  
5. Identity == Full-Res Histogram

#### Parameters

* `K`: Number of rows (coding functions) in coding matrix
* `nt` or `n_tbins`: Number of time bins in uncompressed histogram
* `nr` or `n_rows`: Number of rows
* `nc` or `n_cols`: Number of cols
* `rec-zncc-irf`, `rec-ncc-irf`, `rec-linear-irf`: Algorithms used to compute the look-up table used to estimate depths. ZNCC and NCC depth decoding. linear is only used for coarse histograms. It is not exactly ZNCC but it is faster and performs a bit better because it estimates the depth in the middle of the time bin (ZNCC estimates the depth at the beginning of time bin).
